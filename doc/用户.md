Discord 的用户管理是整个系统中非常重要的一部分，它确保用户权限、角色和状态的正确管理，特别是在一个复杂的、多频道的环境中。Discord 的用户管理涉及多个方面，包括用户认证、身份验证、角色和权限管理、在线状态管理等。

# 描述
## 1. 用户身份认证
Discord 使用 OAuth2 和 JWT（JSON Web Token）来管理用户身份认证。

### 1.1 OAuth2 登录流程
用户登录：当用户使用 Discord 登录时，客户端会将用户重定向到 OAuth2 授权页面，用户通过 Discord 账号授权后，Discord 会返回授权码。
获取 Token：客户端使用授权码请求访问令牌（access token）。这个令牌用来标识和认证用户，允许客户端进行后续的 API 调用。
保持会话：客户端可以将访问令牌和刷新令牌存储起来，在会话有效期内使用它们进行身份验证。
### 1.2 JWT 验证
Token 验证：在 Discord 的 WebSocket 通信中，客户端可能需要通过 JWT 验证身份。WebSocket 连接建立时，客户端需要发送认证消息（如身份信息或 Token），服务器根据 Token 验证用户身份，以确保用户有权限参与相应的聊天频道。
## 2. 用户角色与权限管理
Discord 的权限系统是基于角色（Role-based access control，RBAC）模型来实现的。每个服务器（Guild）都有多个角色，每个角色有不同的权限，可以针对特定频道设置不同的权限。

### 2.1 角色（Roles）
角色定义：服务器管理员可以创建不同的角色（如管理员、普通成员、访客等），并为每个角色分配不同的权限。角色可以是层级式的，较高的角色可以拥有更多的权限。
角色分配：每个用户可以被分配一个或多个角色，角色赋予了用户访问某些频道或执行某些操作的权限。
### 2.2 权限（Permissions）
全局权限：一些权限是全局性的，比如管理服务器、邀请新成员、修改频道设置等。
频道权限：每个频道可以有单独的权限设置，决定了用户是否可以发送消息、查看频道历史、管理频道内容等。
权限优先级：Discord 的权限系统支持继承和优先级处理。较高级别的角色权限会覆盖低级别的角色权限。例如，如果某个用户同时拥有多个角色，则他们会继承所有角色中最宽松的权限。
## 3. 用户状态管理
Discord 提供了丰富的用户状态信息，包括在线、离线、勿扰、隐身等状态，这些状态通过 WebSocket 实时推送给其他用户。

### 3.1 在线状态
状态同步：当用户的状态发生变化（比如从在线变为离线），Discord 会通过 WebSocket 将该状态推送给所有需要了解该用户状态的频道或其他用户。
心跳包检测：Discord 通过心跳包和 WebSocket 连接来检测用户的在线状态。如果心跳包未按预期发送，服务器会将用户状态标记为离线。
### 3.2 用户活动
用户活动：除了在线状态，Discord 还会显示用户的其他活动状态（如游戏中、听音乐、直播等）。这些活动信息会通过 API 或 WebSocket 广播给其他用户。
4. 服务器（Guild）中的用户管理
## 4.用户服务器
### Discord 允许每个服务器（也叫 Guild）有独立的用户管理系统。服务器中的每个用户可以有不同的角色和权限。管理员可以执行多种用户管理操作：

### 4.1 邀请和踢出用户
邀请用户：管理员可以通过生成邀请链接或直接邀请用户加入服务器。
踢出和禁言：管理员可以通过特定的命令或 API 调用踢出用户或禁言（ban）某些用户，防止他们访问服务器。
### 4.2 频道的可见性和访问控制
私有频道：管理员可以创建只有特定角色才能访问的私有频道，确保只有具有相应权限的用户才能查看和发送消息。
频道禁言和限制：管理员可以在特定频道中限制某些用户或角色的操作权限，防止发送消息、上传文件等。
## 5. 用户数据的存储与隐私
Discord 对用户数据的存储非常谨慎，确保用户的隐私和安全。以下是一些 Discord 在用户管理中的数据处理机制：

### 5.1 用户数据加密
数据加密：Discord 使用 HTTPS 和 WebSocket 的加密协议（如 TLS）来确保通信过程中用户数据的安全性。所有传输中的数据都是加密的，以防止中间人攻击。
### 5.2 数据隐私控制
隐私设置：用户可以通过客户端控制自己的隐私设置，选择是否对外公开某些信息（如游戏状态、好友状态等）。
数据最小化：Discord 只会收集用户使用服务所必需的数据，并不会分享给第三方，除非用户明确授权。
## 6. 用户的身份验证与安全措施
Discord 实现了一些安全机制来确保用户账号的安全：

### 6.1 双重身份验证（2FA）
Discord 提供双重身份验证（2FA）来确保用户账号的安全性。用户可以启用 2FA，通过 Google Authenticator 等工具生成临时验证码来保护账号。
### 6.2 登录保护
如果 Discord 发现用户的账号从异常地点登录，可能会要求用户通过额外的验证步骤来确保是合法用户（如通过电子邮件验证登录）。

总结
Discord 的用户管理涉及多个方面，包括：

用户认证：通过 OAuth2 和 JWT 进行用户身份认证和会话管理。
角色和权限系统：基于角色的权限管理系统（RBAC）来管理用户的访问和操作权限。
用户状态管理：通过 WebSocket 实时推送用户的在线状态和活动。
服务器内的用户管理：服务器（Guild）管理员可以管理用户的角色、权限、踢出或禁言用户，控制频道的访问权限。
安全与隐私：通过加密通信、双重身份验证和隐私控制确保用户数据的安全性。 (先不做这个)
这种设计使 Discord 能够灵活地管理大量用户，并为不同用户提供个性化的体验。如果你对某个部分有更详细的问题，或者想探讨具体实现，随时告诉我！

discord:

- 群组管理员
- 普通群组用户
# 数据库设计

设计数据库：
1. 用户表： Users
- id:主键
- username: 用户名
- password_hash: 哈希密码
- email: 邮箱
- created_at: 创立时间
- profile_picture_url: 头像
- statue_message: 状态 在线 注销
- 删除 

2.群组表 Guilds
- id: 主键
- guild_name: 群组名称
- owner_id: 群组所有者的用户 ID
- created_at: 创建时间
- description: 群组描述

3.用户与群组关系表 UserGuilds：
- user_id: 外键，指向用户表
- guild_id: 外键，指向群组表
- joined_at: 用户加入群组的时间

4. 频道表（Channels）：
可以为群组设计频道（类似 Discord 服务器中的频道）：
id: 主键
channel_name: 频道名称
guild_id: 外键，指向群组表
created_at: 频道创建时间
description: 频道描述

5. 用户与频道关系表（UserChannels）：
user_id: 外键，指向用户表
channel_id: 外键，指向频道表
is_muted: 用户是否在该频道被禁言

6. 用户活动日志表（UserActivityLogs）：
id: 主键
user_id: 外键，指向用户表
action: 描述用户的操作（登录、发送消息等）
timestamp: 操作时间
ip_address: 用户进行操作的 IP 地址

7. 角色表: Roles
- id
- role_name
- description

8. 权限表: Permissions
- id
- permission_name
- description

9.用户角色关系: UserRoles
- user_id
- role_id

10.角色权限表
- role_id
- permissions_id


# api 设计
关于用户的api的设计
需要基础的增删改查
### 1.增 用户注册
POST /api/users/register
responce:
```json
{
  "username": "string",
  "password": "string",
  "email": "string"
}
```
request:
- 200 Created: 用户成功
- 400 Bad Request: 参数验证失败

### 2.查 用户登录
POST /api/users/login
responce:
```json
{
  "username": "string",
  "password": "string"
}
```
request

- 200 OK:返回JWT令牌()
```json
{
  "access_token": "string",
  "refresh_token": "string"
}
```
- 401 Unauthorized: 用户或密码错误

### 3.查 用户状态
### 4.查 用户信息获取
### 5.查 用户的角色获取
### 6.改 用户密码修改
### 7.改 用户的名称修改

### 8.删 用户注销
